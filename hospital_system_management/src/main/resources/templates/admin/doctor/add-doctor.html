<!DOCTYPE html>
<html lang="en">

<head>
    <title>Thêm bác sĩ</title>
    <div th:insert="admin/template/menu :: libs"></div>
</head>

<body>
<div class="main-wrapper">
    <div th:insert="admin/template/menu :: headeradmin"></div>
    <div th:insert="admin/template/menu :: menu"></div>
    <div class="page-wrapper">
        <div class="content">
            <div class="row">
                <div class="col-lg-8 offset-lg-2">
                    <h4 class="page-title">Thêm bác sĩ</h4>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-8 offset-lg-2">
                    <form class="register-form" id="register-form" method="post">
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Tên <span class="text-danger">*</span></label>
                                    <input class="form-control" type="text" id="name" placeholder="Nhập tên bác sĩ"
                                           name="name">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Email <span class="text-danger">*</span></label>
                                    <input class="form-control" type="email" name="email" id="email"
                                           placeholder="Nhập email">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Mật khẩu <span class="text-danger">*</span></label>
                                    <input class="form-control" name="password" type="password" id="password"
                                           placeholder="Nhập mật khẩu">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Nhập lại mật khẩu <span class="text-danger">*</span></label>
                                    <input class="form-control" type="password" name="re-pass" id="re-pass"
                                           placeholder="Nhập lại mật khẩu">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <div>
                                        <label>Ngày sinh <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="dob" name="dob">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Số điện thoại <span class="text-danger">*</span></label>
                                    <input class="form-control" type="text" id="phone" name="phone">
                                </div>
                            </div>

                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label for="gender">Giới tính <span class="text-danger">*</span></label><br>
                                    <select id="gender" name="gender" class="w-100" style="border-radius: 5px; height: 40px">
                                        <option th:each="gender : ${T(com.example.hospital_management.statics.Gender).values()}"
                                                th:value="${gender}"
                                                th:text="${#strings.capitalize(gender.name.toString())}">
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label for="doctorLevel">Trình độ <span class="text-danger">*</span></label><br>
                                    <select id="doctorLevel" name="doctorLevel" class="w-100 py-1" style="border-radius: 5px; height: 40px">
                                        <option th:each="level : ${T(com.example.hospital_management.statics.DoctorLevel).values()}"
                                                th:value="${level}"
                                                th:text="${#strings.capitalize(level.name.toString())}">
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <label for="speciality" class="form-label">Chuyên khoa <span class="text-danger">*</span></label>
                                <select class="form-control py-2" id="speciality" multiple="multiple" name="speciality"
                                        required>
                                    <option th:each="speciality : ${listAllSpecialities}" th:value="${speciality.id}"
                                            th:text="${speciality.name}">
                                    </option>
                                </select>
                            </div>



                            <div class="col-sm-12">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="form-group">
                                            <label>Địa chỉ <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control " id="address">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">

                        </div>
                        <div class="form-group">
                            <label>Giới thiệu ngắn</label>
                            <textarea class="form-control" rows="3" cols="30" id="introduce"></textarea>
                        </div>

                        <div class="mt-30">
                            <div class="lh-1 text-16 text-light-1">Ảnh đại diện</div>
                            <div class="row x-gap-20 y-gap-20 pt-15">
                                <div class="col-auto">
                                    <div class="w-200">
                                        <div id="avatar-doctor"
                                             class="d-flex ratio ratio-1:1">
                                            <button class="btn-upload-image flex-center flex-column text-center bg-blue-2 h-full w-1/1 absolute rounded-4 border-type-1">
                                                <div class="icon-upload-file text-40 text-blue-1 mb-10"></div>
                                            </button>
                                        </div>
                                        <div class="text-center mt-10 text-14 text-light-1">
                                            <input type="file" id="fileInput" >
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="m-t-20 text-center">
                            <button class="btn btn-primary submit-btn" type="submit" name="signup" id="signup">Tạo bác sĩ
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>
<div class="sidebar-overlay" data-reff=""></div>


</body>


<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<!-- axios -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>


<!--  toastr.js-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-storage.js"></script>


<script th:inline="javascript">

    // Cấu hình thông tin Firebase của bạn
    let firebaseConfig = {
        apiKey: "AIzaSyCPfxKN6sz8b7ndgoENeNqZ3FnwVjKTCZM",
        authDomain: "hospital-management-syst-24909.firebaseapp.com",
        projectId: "hospital-management-syst-24909",
        storageBucket: "hospital-management-syst-24909.appspot.com",
        messagingSenderId: "516287285398",
        appId: "1:516287285398:web:19ce4b60a5e6f83ea45ab7",
        measurementId: "G-8PYB0H7K7R",
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);

    // Lấy tham chiếu đến Firebase Storage bucket
    let storage = firebase.storage();
    let storageRef = storage.ref();

    $(document).ready(function () {

        //open chosen image form
        // $('.btn-upload-image').click(() => {
        //     $('#fileInput').click();
        // });

        // show image
        let chosenFile = null;
        $('#fileInput').change(event => {
            const maxSizeInBytes = 5242880;
            const tempFiles = event.target.files;
            if (!tempFiles || tempFiles.length === 0) {
                return;
            }
            chosenFile = tempFiles[0];
            if (chosenFile && chosenFile.size > maxSizeInBytes) {
                alert("File size exceeded the allowed limit (5MB)!");
                this.value = '';
                return;
            }
            const imageBlob = new Blob([chosenFile], {type: chosenFile.type});
            const imageUrl = URL.createObjectURL(imageBlob);
            $('#avatar-doctor .btn-upload-image').empty();
            let showImageHtml = `<img alt='Avatar' style="width: 200px; height: 100%; object-fit: cover" src='${imageUrl}'/>`;
            $('#avatar-doctor .btn-upload-image').append(showImageHtml)
        });

        // Kích hoạt select2
        const doctor_speciality = $("#speciality");
        doctor_speciality.select2({
            placeholder: "Chọn chuyên khoa",
        });

        toastr.options = {
            positionClass: 'toast-center',
            timeOut: 0
        }
        $(".register-form").validate({
            onfocusout: false,
            onkeyup: false,
            onclick: false,
            errorPlacement: function (error, element) {
                error.addClass("error-message");
                error.insertAfter(element.parent());
            },
            rules: {
                "name" : {
                    required: true
                },
                "email": {
                    required: true,
                    email: true
                },
                "password": {
                    required: true,
                },
                "re-pass": {
                    required: true,
                    equalTo: "#password"
                },
                "dob": {
                    required: true,
                },
                "phone": {
                    required: true,
                }
            },
            messages: {
                "name": {
                    required: "Vui lòng nhập tên",
                },
                "email": {
                    required: "Vui lòng nhập email",
                    email: "Email không đúng định dạng"
                },
                "password": {
                    required: "Vui lòng nhập password"
                },
                "re-pass": {
                    required: "Vui lòng nhập lại password",
                    equalTo: "Nhập lại mật khẩu chưa chính xác"
                },
                "dob": {
                    required: "Vui lòng chọn ngày sinh",
                },
                "phone": {
                    required: "Vui lòng nhập số điện thoại",
                }
            }
        })

        async function uploadImageAndCreateDoctor() {
            let name = $('#name').val();
            let email = $('#email').val();
            let phone = $('#phone').val();
            let password = $('#password').val();
            let address = $('#address').val();
            let introduce = $('#introduce').val();
            let dob = $('#dob').val();
            let gender = $('#gender').val();
            let doctorLevel = $('#doctorLevel').val();
            let selectedSpecialities = [];
            $('#speciality option:selected').each(function () {
                selectedSpecialities.push($(this).val());
            })

            let newDoctor = {
                name: name,
                email: email,
                phone: phone,
                password: password,
                address: address,
                introduce: introduce,
                dob: dob,
                gender: gender,
                avatar: "",
                specialityIds: selectedSpecialities,
                level: doctorLevel
            };

            console.log(newDoctor);
            // Upload the image first
            if (chosenFile != null) {
                newDoctor.avatar = await uploadImage(chosenFile);
                createDoctor(newDoctor);
            } else {
                createDoctor(newDoctor);
            }
        }

        function createDoctor(newDoctor) {
            $.ajax({
                type: 'POST',
                url: '/api/v1/authentication/signupDoctor',
                contentType: "application/json",
                data: JSON.stringify(newDoctor),
                success: function (response) {
                    $('#signup').prop('disabled', false);
                    toastr.success("Tạo bác sĩ thành công!");
                    setTimeout(function () {
                        window.location.href="http://localhost:8080/admin/doctors"
                    }, 100)
                },
                error: function () {
                    toastr.warning("Tạo bác sĩ thất bại!");
                }
            });
        }

        async function uploadImage(chosenFile) {
            try {
                let imageName = chosenFile.name;
                let imageRef = storageRef.child("images/" + imageName);
                let snapshort = await imageRef.put(chosenFile);
                return await snapshort.ref.getDownloadURL();
            } catch (error) {
                throw error;
            }
        }

        $('#signup').click(event => {
            console.log("click");
            event.preventDefault();
            let isValidForm = $("#register-form").valid();
            if (!isValidForm) return;
            $('#signup').prop('disabled', true);
            uploadImageAndCreateDoctor();
        })
    })
</script>
</html>
